
import React from 'react'
import { View, Button, Text, TextInput } from 'react-native'
import { styles, colors, windowSize } from '../../StyleSheet'
import { connect } from 'react-redux'
import { getUserToken } from '../../../Redux/Action/action';
import { checkPatientPassword, updatePatientPassword } from '../../../API/APIConnection';

class PasswordProfile extends React.Component {
  constructor(props) {
    super(props)
    this.state = {
      oldPassword: "",
      newPassword: "",
      confirmPassword: "",
      sameNewPassword: true
    }
  }

  newPasswordSubmitted = () => {
    if (this.state.newPassword == this.state.confirmPassword && this.state.newPassword != "" && this.state.confirmPassword != "") {
      checkPatientPassword(this.props.token.token, this.state.oldPassword).then(async data => {
        updatePatientPassword(this.props.token.token, this.state.oldPassword, this.state.newPassword).then(async data => {
          if (data.status == 200) {
            this.setState({ sameNewPassword: true })
            this.props.navigation.navigate('Profile');
          } else {
            this.setState({ sameNewPassword: false })
          }
        })
      })
    } else {
      this.setState({ sameNewPassword: false })
    }
  }

  setOldPassword = (text) => {
    this.setState({ oldPassword: text })
  }

  setNewPassword = (text) => {
    this.setState({ newPassword: text })
  }

  setConfirmPassword = (text) => {
    this.setState({ confirmPassword: text })
  }

  render() {
    let { navigate } = this.props.navigation;
    return (
      <View style={{flex: 1, justifyContent: "space-around"}}>
        <View style={{ flex: 1, alignItems: "center" }}>
          <Text> PasswordProfile Page </Text>
          <View style={{ flex: 1, justifyContent: "center", alignContent: 'center'}}>
            <Text> Ancient mot de passe </Text>
            <TextInput
              placeholder="ancient mot de passe"
              onChangeText={(text) => this.setOldPassword(text)}
              style={styles.textField, { width: windowSize.x / 1.5, borderWidth: 1 }}
            />
            <Text> Nouveau mot de passe </Text>
            <TextInput
              placeholder="nouveau mot de passe"
              onChangeText={(text) => this.setNewPassword(text)}
              style={styles.textField, { width: windowSize.x / 1.5, borderWidth: 1 }}
            />
            <Text> Confirmer nouveau mot de passe </Text>
            <TextInput
              placeholder="confirmation"
              onChangeText={(text) => this.setConfirmPassword(text)}
              style={styles.textField, { width: windowSize.x / 1.5, borderWidth: 1 }}
            />
          </View>
        </View>
        { this.state.sameNewPassword ?
          null
          :
          <Text style={{color: colors.errorColor}}> /!\ Invalid password or new password doesn't match ! /!\ </Text>
        }
        <View style={{flex: 1, flexDirection: 'row',  justifyContent: 'space-around'}}>
          <View>
            <Button 
              color="#62BE87"
              style={{ height: 40, width: 50, borderWidth: 2, borderColor: '#000000'}}
              onPress={() => navigate('Profile')}
              title="Retour"
            />
          </View>
          <View>
          <Button 
            color="#62BE87"
            style={{ height: 40, width: 50, borderWidth: 2, borderColor: '#000000'}}
            onPress={() => this.newPasswordSubmitted()}
            title="Confirmer"
          />
          </View>
        </View>
      </View>
    )
  }
}

const mapStateToProps = state => ({
  token: state.token,
});

const mapDispatchToProps = dispatch => ({
  getUserToken: () => dispatch(getUserToken()),
  getUserToken: () => dispatch(getUserToken())
});

export default connect(mapStateToProps, mapDispatchToProps)(PasswordProfile)
